name: Release Linux and macOS Binaries

"on":
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_linux:
        description: "Build Linux assets"
        type: boolean
        default: true
      build_macos:
        description: "Build macOS assets (regular runners only)"
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: release-linux-macos-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ${{ matrix.os }}
    if: >
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.build_linux == 'true' ||
      github.event.inputs.build_macos == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-x64
            platform: linux
            os: ubuntu-24.04
            qt_host: linux
            qt_arch: linux_gcc_64
            artifact_name: linux-x64-release-assets
          - id: linux-arm64
            platform: linux
            os: ubuntu-24.04-arm
            qt_host: linux_arm64
            qt_arch: linux_gcc_arm64
            artifact_name: linux-arm64-release-assets
          - id: macos-14-arm64
            platform: macos
            os: macos-14
            qt_host: mac
            qt_arch: clang_64
            artifact_name: macos14-arm64-release-assets
          - id: macos-15-intel
            platform: macos
            os: macos-15-intel
            qt_host: mac
            qt_arch: clang_64
            artifact_name: macos15-intel-release-assets
          - id: macos-15-arm64
            platform: macos
            os: macos-15
            qt_host: mac
            qt_arch: clang_64
            artifact_name: macos15-arm64-release-assets
          - id: macos-26-arm64
            platform: macos
            os: macos-26
            qt_host: mac
            qt_arch: clang_64
            artifact_name: macos26-arm64-release-assets
    env:
      TB_PLATFORM: ${{ matrix.platform }}
      TB_RELEASE_TAG: ${{ github.ref_type == 'tag' && github.ref_name || '' }}
      TB_ASSET_LABEL: ${{ matrix.id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            Languages/Python/requirements.txt

      - name: Install Linux packaging dependencies
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libminizip1t64 \
            libasound2t64 \
            libdbus-1-3 \
            libegl1 \
            libgbm1 \
            libxcomposite1 \
            libxdamage1 \
            libxkbcommon-x11-0 \
            libxrandr2 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xkb1 \
            patchelf \
            rpm \
            ruby \
            ruby-dev
          sudo gem install --no-document fpm

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.2"
          host: ${{ matrix.qt_host }}
          target: desktop
          arch: ${{ matrix.qt_arch }}
          modules: qtwebengine qtwebsockets qtwebchannel qtpositioning

      - name: Resolve Qt CMake path
        shell: bash
        run: |
          set -euo pipefail
          qt_prefix="$(qmake -query QT_INSTALL_PREFIX)"
          echo "QT_CMAKE_DIR=${qt_prefix}/lib/cmake/Qt6" >> "${GITHUB_ENV}"

      - name: Install Python dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install pyinstaller
          python -m pip install -r Languages/Python/requirements.txt

      - name: Build Python binary
        shell: bash
        run: |
          set -euo pipefail
          chmod +x Languages/Python/tools/build_binary.sh
          Languages/Python/tools/build_binary.sh \
            --python python \
            --name Trading-Bot-Python \
            --skip-dependency-install \
            --release-tag "${TB_RELEASE_TAG}"

      - name: Configure C++ build
        shell: bash
        run: |
          set -euo pipefail
          cmake -S "Languages/C++" \
                -B "build/binance_cpp" \
                -DCMAKE_BUILD_TYPE=Release \
                -DQt6_DIR="${QT_CMAKE_DIR}" \
                -DTB_REQUIRE_QT_WEBENGINE=ON

      - name: Build C++ binary
        shell: bash
        run: |
          set -euo pipefail
          cmake --build "build/binance_cpp" --config Release --parallel

      - name: Install C++ runtime bundle
        shell: bash
        run: |
          set -euo pipefail
          install_prefix="${GITHUB_WORKSPACE}/release/Trading-Bot-C++"
          rm -rf "${install_prefix}"
          cmake --install "build/binance_cpp" --config Release --prefix "${install_prefix}"

      - name: Package release assets
        shell: bash
        run: |
          set -euo pipefail
          chmod +x .github/scripts/package_linux_macos_release.sh
          .github/scripts/package_linux_macos_release.sh

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: release/*
          if-no-files-found: error

  publish-release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          pattern: "*-release-assets"
          merge-multiple: true
          path: release

      - name: Show release files
        shell: bash
        run: |
          set -euo pipefail
          ls -lah release

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
